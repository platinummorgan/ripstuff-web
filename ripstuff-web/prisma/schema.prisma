generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model BannedDevice {
  deviceHash String   @id @map("device_hash") @db.VarChar(128)
  reason     String?  @db.VarChar(280)
  bannedAt   DateTime @map("banned_at") @default(now())
  bannedBy   String   @map("banned_by") @db.VarChar(128)
  expiresAt  DateTime? @map("expires_at")
  isActive   Boolean  @map("is_active") @default(true)
  createdAt  DateTime @map("created_at") @default(now())
  updatedAt  DateTime @map("updated_at") @updatedAt

  @@map("banned_devices")
  @@index([isActive, bannedAt], map: "idx_banned_device_active")
  @@index([expiresAt], map: "idx_banned_device_expires")
}

model ContactMessage {
  id               String   @id @default(uuid()) @db.Uuid
  senderDeviceHash String   @map("sender_device_hash") @db.VarChar(128)
  subject          String   @db.VarChar(120)
  message          String
  status           String   @default("UNREAD") @db.VarChar(20)
  createdAt        DateTime @map("created_at") @default(now())
  resolvedAt       DateTime? @map("resolved_at")
  moderatorNotes   String?  @map("moderator_notes")

  @@map("contact_messages")
  @@index([senderDeviceHash, createdAt], map: "idx_contact_messages_device_created_at")
  @@index([status, createdAt], map: "idx_contact_messages_status_created_at")
}

model EulogyDraft {
  id         String        @id @default(uuid()) @db.Uuid
  deviceHash String        @map("device_hash") @db.VarChar(128)
  title      String        @db.VarChar(120)
  yearsText  String?       @map("years_text") @db.VarChar(32)
  backstory  String?       @db.VarChar(140)
  category   GraveCategory
  eulogyText String        @map("eulogy_text")
  tokensUsed Int           @map("tokens_used")
  createdAt  DateTime      @map("created_at") @default(now())
  expiresAt  DateTime      @map("expires_at")
  emotion    String        @default("heartfelt") @db.VarChar(20)

  @@map("eulogy_drafts")
  @@index([deviceHash, createdAt], map: "idx_eulogy_draft_device_created")
}

model Grave {
  id                  String                 @id @default(uuid()) @db.Uuid
  slug                String                 @unique @db.VarChar(128)
  title               String                 @db.VarChar(120)
  datesText           String?                @map("dates_text") @db.VarChar(64)
  backstory           String?                @db.VarChar(140)
  photoUrl            String?                @map("photo_url") @db.VarChar(2048)
  eulogyText          String                 @map("eulogy_text")
  category            GraveCategory
  status              GraveStatus            @default(PENDING)
  heartCount          Int                    @map("heart_count") @default(0)
  candleCount         Int                    @map("candle_count") @default(0)
  roseCount           Int                    @map("rose_count") @default(0)
  lolCount            Int                    @map("lol_count") @default(0)
  featured            Boolean                @default(false)
  createdAt           DateTime               @map("created_at") @default(now())
  updatedAt           DateTime               @map("updated_at") @updatedAt
  creatorDeviceHash   String?                @map("creator_device_hash") @db.VarChar(128)
  mapX                Int?                   @map("map_x")
  mapY                Int?                   @map("map_y")
  eulogyCount         Int                    @map("eulogy_count") @default(0)
  roastCount          Int                    @map("roast_count") @default(0)
  moderationTrail   ModerationAction[]
  reactionEvents      ReactionEvent[]
  reports             Report[]
  roastEulogyReactions RoastEulogyReaction[]
  sympathies          Sympathy[]

  @@map("graves")
  @@index([createdAt], map: "idx_graves_created_at")
  @@index([creatorDeviceHash, createdAt], map: "idx_graves_creator_created_at")
  @@index([mapX, mapY, status], map: "idx_graves_map_coords_status")
  @@index([status, featured, createdAt], map: "idx_graves_status_featured_created_at")
}

model ModerationAction {
  id          String               @id @default(uuid()) @db.Uuid
  graveId     String               @map("grave_id") @db.Uuid
  moderatorId String?              @map("moderator_id") @db.VarChar(64)
  action      ModerationActionType
  reason      String?              @db.VarChar(280)
  createdAt   DateTime             @map("created_at") @default(now())
  grave       Grave                @relation(fields: [graveId], references: [id], onDelete: Cascade)

  @@map("moderation_actions")
  @@index([graveId, createdAt], map: "idx_moderation_grave_created_at")
}

model OAuthAccount {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  provider   String   @db.VarChar(20)
  providerId String   @map("provider_id") @db.VarChar(100)
  email      String?  @db.VarChar(255)
  name       String?  @db.VarChar(100)
  picture    String?  @db.VarChar(500)
  createdAt  DateTime @map("created_at") @default(now())
  updatedAt  DateTime @map("updated_at") @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("oauth_accounts")
  @@unique([provider, providerId], map: "uq_oauth_accounts_provider_id")
  @@index([provider], map: "idx_oauth_accounts_provider")
  @@index([userId], map: "idx_oauth_accounts_user_id")
}

model RateLimit {
  id          BigInt   @id @default(autoincrement())
  deviceHash  String   @map("device_hash") @db.VarChar(128)
  scope       String   @db.VarChar(64)
  windowStart DateTime @map("window_start")
  count       Int      @default(0)
  expiresAt   DateTime? @map("expires_at")

  @@map("rate_limits")
  @@index([deviceHash, scope, windowStart], map: "idx_ratelimit_device_scope_window")
}

model ReactionEvent {
  id           BigInt       @id @default(autoincrement())
  graveId      String       @map("grave_id") @db.Uuid
  deviceHash   String       @map("device_hash") @db.VarChar(128)
  type       ReactionType @map("reaction_type")
  createdAt    DateTime     @map("created_at") @default(now())
  grave        Grave        @relation(fields: [graveId], references: [id], onDelete: Cascade)

  @@map("reaction_events")
  @@unique([graveId, deviceHash, type], map: "uq_reaction_grave_device_type")
  @@index([graveId, createdAt], map: "idx_reaction_grave_created_at")
}

model Report {
  id         String   @id @default(uuid()) @db.Uuid
  graveId    String   @map("grave_id") @db.Uuid
  deviceHash String   @map("device_hash") @db.VarChar(128)
  reason     String?  @db.VarChar(280)
  createdAt  DateTime @map("created_at") @default(now())
  resolvedAt DateTime? @map("resolved_at")
  grave      Grave    @relation(fields: [graveId], references: [id], onDelete: Cascade)

  @@map("reports")
  @@unique([graveId, deviceHash], map: "uq_report_grave_device")
  @@index([graveId, createdAt], map: "idx_report_grave_created_at")
}

model RoastEulogyReaction {
  id         String          @id @default(uuid()) @db.Uuid
  graveId    String          @map("grave_id") @db.Uuid
  deviceHash String          @map("device_hash") @db.VarChar(128)
  type       RoastEulogyType
  createdAt  DateTime        @map("created_at") @default(now())
  grave      Grave           @relation(fields: [graveId], references: [id], onDelete: Cascade)

  @@map("roast_eulogy_reactions")
  @@unique([graveId, deviceHash], map: "uq_roast_eulogy_grave_device")
  @@index([graveId, createdAt], map: "idx_roast_eulogy_grave_created_at")
}

model Sympathy {
  id         String   @id @default(uuid()) @db.Uuid
  graveId    String   @map("grave_id") @db.Uuid
  deviceHash String   @map("device_hash") @db.VarChar(128)
  body       String   @db.VarChar(140)
  createdAt  DateTime @map("created_at") @default(now())
  deletedAt  DateTime? @map("deleted_at")
  grave      Grave    @relation(fields: [graveId], references: [id], onDelete: Cascade)

  @@map("sympathies")
  @@index([deviceHash, createdAt], map: "idx_sympathy_device_created_at")
  @@index([graveId, createdAt], map: "idx_sympathy_grave_created_at")
}

model UserModerationAction {
  id               String               @id @default(uuid()) @db.Uuid
  targetUserId     String?              @map("target_user_id") @db.Uuid
  targetDeviceHash String?              @map("target_device_hash") @db.VarChar(128)
  moderatorId      String?              @map("moderator_id") @db.VarChar(64)
  action           ModerationActionType
  reason           String?              @db.VarChar(280)
  expiresAt        DateTime?            @map("expires_at")
  metadata         String?
  createdAt        DateTime             @map("created_at") @default(now())

  @@map("user_moderation_actions")
  @@index([action, createdAt], map: "idx_user_moderation_action_created_at")
  @@index([targetDeviceHash, createdAt], map: "idx_user_moderation_device_created_at")
  @@index([targetUserId, createdAt], map: "idx_user_moderation_user_created_at")
}

model User {
  id             String         @id @default(uuid()) @db.Uuid
  deviceHash     String?        @map("device_hash") @db.VarChar(128)
  createdAt      DateTime       @map("created_at") @default(now())
  updatedAt      DateTime       @map("updated_at") @updatedAt
  email          String         @unique @db.VarChar(255)
  name           String?        @db.VarChar(100)
  picture        String?        @db.VarChar(500)
  provider       String         @db.VarChar(20)
  providerId     String         @map("provider_id") @db.VarChar(100)
  isModerator    Boolean        @map("is_moderator") @default(false)
  banExpiresAt   DateTime?      @map("ban_expires_at")
  banReason      String?        @map("ban_reason") @db.VarChar(280)
  bannedAt       DateTime?      @map("banned_at")
  bannedBy       String?        @map("banned_by") @db.VarChar(128)
  isBanned       Boolean        @map("is_banned") @default(false)
  suspendedUntil DateTime?      @map("suspended_until")
  oauthAccounts  OAuthAccount[]

  @@map("users")
  @@unique([provider, providerId], map: "uq_user_provider_id")
  @@index([isBanned, bannedAt], map: "idx_user_banned")
  @@index([deviceHash], map: "idx_user_device_hash")
  @@index([email], map: "idx_user_email")
  @@index([suspendedUntil], map: "idx_user_suspended")
}

enum GraveCategory {
  TECH_GADGETS
  KITCHEN_FOOD
  CLOTHING_LAUNDRY
  TOYS_GAMES
  CAR_TOOLS
  PETS_CHEWABLES
  OUTDOORS_ACCIDENTS
  MISC
}

enum GraveStatus {
  PENDING
  APPROVED
  HIDDEN
}

enum ModerationActionType {
  APPROVE
  HIDE
  FEATURE
  UNHIDE
  NOTE
  DELETE
  BAN_USER
  UNBAN_USER
  BAN_DEVICE
  UNBAN_DEVICE
  SUSPEND_USER
}

enum ReactionType {
  HEART
  CANDLE
  ROSE
  LOL
}

enum RoastEulogyType {
  ROAST
  EULOGY
}
