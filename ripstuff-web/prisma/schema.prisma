generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Grave {
  id                String             @id @default(uuid()) @map("id") @db.Uuid
  slug              String             @unique @map("slug") @db.VarChar(128)
  title             String             @map("title") @db.VarChar(120)
  datesText         String?            @map("dates_text") @db.VarChar(64)
  backstory         String?            @map("backstory") @db.VarChar(140)
  photoUrl          String?            @map("photo_url") @db.VarChar(2048)
  eulogyText        String             @map("eulogy_text")
  category          GraveCategory      @map("category")
  status            GraveStatus        @default(PENDING) @map("status")
  heartCount        Int                @default(0) @map("heart_count")
  candleCount       Int                @default(0) @map("candle_count")
  roseCount         Int                @default(0) @map("rose_count")
  lolCount          Int                @default(0) @map("lol_count")
  featured          Boolean            @default(false) @map("featured")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  creatorDeviceHash String?            @map("creator_device_hash") @db.VarChar(128)
  mapX              Int?               @map("map_x")
  mapY              Int?               @map("map_y")
  moderationTrail   ModerationAction[] @relation("GraveModerationActions")
  reactionEvents    ReactionEvent[]    @relation("GraveReactionEvents")
  reports           Report[]           @relation("GraveReports")
  sympathies        Sympathy[]         @relation("GraveSympathies")

  @@index([status, featured, createdAt], map: "idx_graves_status_featured_created_at")
  @@index([creatorDeviceHash, createdAt], map: "idx_graves_creator_created_at")
  @@index([createdAt], map: "idx_graves_created_at")
  @@index([mapX, mapY, status], map: "idx_graves_map_coords_status")
  @@map("graves")
}

model Sympathy {
  id         String    @id @default(uuid()) @map("id") @db.Uuid
  graveId    String    @map("grave_id") @db.Uuid
  deviceHash String    @map("device_hash") @db.VarChar(128)
  body       String    @map("body") @db.VarChar(140)
  createdAt  DateTime  @default(now()) @map("created_at")
  deletedAt  DateTime? @map("deleted_at")
  grave      Grave     @relation("GraveSympathies", fields: [graveId], references: [id], onDelete: Cascade)

  @@index([graveId, createdAt], map: "idx_sympathy_grave_created_at")
  @@index([deviceHash, createdAt], map: "idx_sympathy_device_created_at")
  @@map("sympathies")
}

model ReactionEvent {
  id         BigInt       @id @default(autoincrement()) @map("id")
  graveId    String       @map("grave_id") @db.Uuid
  deviceHash String       @map("device_hash") @db.VarChar(128)
  type       ReactionType @map("reaction_type")
  createdAt  DateTime     @default(now()) @map("created_at")
  grave      Grave        @relation("GraveReactionEvents", fields: [graveId], references: [id], onDelete: Cascade)

  @@unique([graveId, deviceHash, type], map: "uq_reaction_grave_device_type")
  @@index([graveId, createdAt], map: "idx_reaction_grave_created_at")
  @@map("reaction_events")
}

model ModerationAction {
  id          String               @id @default(uuid()) @map("id") @db.Uuid
  graveId     String               @map("grave_id") @db.Uuid
  moderatorId String?              @map("moderator_id") @db.VarChar(64)
  action      ModerationActionType @map("action")
  reason      String?              @map("reason") @db.VarChar(280)
  createdAt   DateTime             @default(now()) @map("created_at")
  grave       Grave                @relation("GraveModerationActions", fields: [graveId], references: [id], onDelete: Cascade)

  @@index([graveId, createdAt], map: "idx_moderation_grave_created_at")
  @@map("moderation_actions")
}

model Report {
  id         String    @id @default(uuid()) @map("id") @db.Uuid
  graveId    String    @map("grave_id") @db.Uuid
  deviceHash String    @map("device_hash") @db.VarChar(128)
  reason     String?   @map("reason") @db.VarChar(280)
  createdAt  DateTime  @default(now()) @map("created_at")
  resolvedAt DateTime? @map("resolved_at")
  grave      Grave     @relation("GraveReports", fields: [graveId], references: [id], onDelete: Cascade)

  @@unique([graveId, deviceHash], map: "uq_report_grave_device")
  @@index([graveId, createdAt], map: "idx_report_grave_created_at")
  @@map("reports")
}

model EulogyDraft {
  id         String        @id @default(uuid()) @map("id") @db.Uuid
  deviceHash String        @map("device_hash") @db.VarChar(128)
  title      String        @map("title") @db.VarChar(120)
  yearsText  String?       @map("years_text") @db.VarChar(32)
  backstory  String?       @map("backstory") @db.VarChar(140)
  category   GraveCategory @map("category")
  eulogyText String        @map("eulogy_text")
  tokensUsed Int           @map("tokens_used")
  createdAt  DateTime      @default(now()) @map("created_at")
  expiresAt  DateTime      @map("expires_at")
  emotion    String        @default("heartfelt") @map("emotion") @db.VarChar(20)

  @@index([deviceHash, createdAt], map: "idx_eulogy_draft_device_created")
  @@map("eulogy_drafts")
}

model User {
  id             String         @id @default(uuid()) @map("id") @db.Uuid
  deviceHash     String?        @map("device_hash") @db.VarChar(128)
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  email          String         @unique @map("email") @db.VarChar(255)
  name           String?        @map("name") @db.VarChar(100)
  picture        String?        @map("picture") @db.VarChar(500)
  provider       String         @map("provider") @db.VarChar(20)
  providerId     String         @map("provider_id") @db.VarChar(100)
  isModerator    Boolean        @default(false) @map("is_moderator")
  banExpiresAt   DateTime?      @map("ban_expires_at")
  banReason      String?        @map("ban_reason") @db.VarChar(280)
  bannedAt       DateTime?      @map("banned_at")
  bannedBy       String?        @map("banned_by") @db.VarChar(128)
  isBanned       Boolean        @default(false) @map("is_banned")
  suspendedUntil DateTime?      @map("suspended_until")
  oauthAccounts  OAuthAccount[] @relation("UserOAuthAccounts")

  @@unique([provider, providerId], map: "uq_user_provider_id")
  @@index([deviceHash], map: "idx_user_device_hash")
  @@index([email], map: "idx_user_email")
  @@index([isBanned, bannedAt], map: "idx_user_banned")
  @@index([suspendedUntil], map: "idx_user_suspended")
  @@map("users")
}

model OAuthAccount {
  id         String   @id @default(uuid()) @map("id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  provider   String   @map("provider") @db.VarChar(20)
  providerId String   @map("provider_id") @db.VarChar(100)
  email      String?  @map("email") @db.VarChar(255)
  name       String?  @map("name") @db.VarChar(100)
  picture    String?  @map("picture") @db.VarChar(500)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  user       User     @relation("UserOAuthAccounts", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId], map: "uq_oauth_accounts_provider_id")
  @@index([userId], map: "idx_oauth_accounts_user_id")
  @@index([provider], map: "idx_oauth_accounts_provider")
  @@map("oauth_accounts")
}

model RateLimit {
  id          BigInt    @id @default(autoincrement()) @map("id")
  deviceHash  String    @map("device_hash") @db.VarChar(128)
  scope       String    @map("scope") @db.VarChar(64)
  windowStart DateTime  @map("window_start")
  count       Int       @default(0) @map("count")
  expiresAt   DateTime? @map("expires_at")

  @@index([deviceHash, scope, windowStart], map: "idx_ratelimit_device_scope_window")
  @@map("rate_limits")
}

model ContactMessage {
  id               String    @id @default(uuid()) @map("id") @db.Uuid
  senderDeviceHash String    @map("sender_device_hash") @db.VarChar(128)
  subject          String    @map("subject") @db.VarChar(120)
  message          String    @map("message")
  status           String    @default("UNREAD") @map("status") @db.VarChar(20)
  createdAt        DateTime  @default(now()) @map("created_at")
  resolvedAt       DateTime? @map("resolved_at")
  moderatorNotes   String?   @map("moderator_notes")

  @@index([status, createdAt], map: "idx_contact_messages_status_created_at")
  @@index([senderDeviceHash, createdAt], map: "idx_contact_messages_device_created_at")
  @@map("contact_messages")
}

model BannedDevice {
  deviceHash String    @id @map("device_hash") @db.VarChar(128)
  reason     String?   @map("reason") @db.VarChar(280)
  bannedAt   DateTime  @default(now()) @map("banned_at")
  bannedBy   String    @map("banned_by") @db.VarChar(128)
  expiresAt  DateTime? @map("expires_at")
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  @@index([isActive, bannedAt], map: "idx_banned_device_active")
  @@index([expiresAt], map: "idx_banned_device_expires")
  @@map("banned_devices")
}

model UserModerationAction {
  id               String               @id @default(uuid()) @map("id") @db.Uuid
  targetUserId     String?              @map("target_user_id") @db.Uuid
  targetDeviceHash String?              @map("target_device_hash") @db.VarChar(128)
  moderatorId      String?              @map("moderator_id") @db.VarChar(64)
  action           ModerationActionType @map("action")
  reason           String?              @map("reason") @db.VarChar(280)
  expiresAt        DateTime?            @map("expires_at")
  metadata         String?              @map("metadata")
  createdAt        DateTime             @default(now()) @map("created_at")

  @@index([targetUserId, createdAt], map: "idx_user_moderation_user_created_at")
  @@index([targetDeviceHash, createdAt], map: "idx_user_moderation_device_created_at")
  @@index([action, createdAt], map: "idx_user_moderation_action_created_at")
  @@map("user_moderation_actions")
}

enum GraveStatus {
  PENDING
  APPROVED
  HIDDEN
}

enum GraveCategory {
  TECH_GADGETS
  KITCHEN_FOOD
  CLOTHING_LAUNDRY
  TOYS_GAMES
  CAR_TOOLS
  PETS_CHEWABLES
  OUTDOORS_ACCIDENTS
  MISC
}

enum ModerationActionType {
  APPROVE
  HIDE
  FEATURE
  UNHIDE
  NOTE
  DELETE
  BAN_USER
  UNBAN_USER
  BAN_DEVICE
  UNBAN_DEVICE
  SUSPEND_USER
}

enum ReactionType {
  HEART
  CANDLE
  ROSE
  LOL
}
